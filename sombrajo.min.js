!function(e,t){"use strict";"function"==typeof define&&define.amd?define(["d3"],t):"undefined"!=typeof exports?module.exports=t(require("d3"),exports):e.Sombrajo=t(e.d3)}(this,function(e){"use strict";function t(e){e=e||{},n={},n.container=e.container||document,n.content_selector=e.content_selector||"data-entry-id",n.value_selector=e.value_selector||"data-entry-value",n.opacity=e.opacity||.7,n.glow=e.glow||0,n.scale=e.scale||"linear",o=e.collection||[],this.setCollection()}var n,o,r;t.prototype={updateConfig:function(e){for(var t in e)n[t]=e[t];this.setCollection()},setCollection:function(e){if("undefined"!=typeof e&&null!==e){for(var t=0;t<o.length;t++)c(o[t]);o=e}return l(),r=y(),u(),o},refreshMap:function(e,t){e=e||{},t=t||!1;for(var l=n.container.querySelectorAll("["+n.content_selector+"]").length,a=0,i=0;i<o.length;i++)a+=o[i].plots.length;e.value>r.max||t||l>a?this.setCollection():u(e)},getEntryValue:function(e){var t=s(e);return"undefined"!=typeof t&&null!==t?t.value:void 0},updateEntryValue:function(e,t){var n=s(e);if(null!==n){var o=n.value===r.max;n.value=t,this.refreshMap(n,o)}},addEntry:function(e){var t=s(e);null===t&&(l(e),this.refreshMap(e))},removeEntry:function(e){var t=s(e);null!==t&&(c(t),t.value===r.max&&this.setCollection())},hide:function(){for(var e=f(),t=0;t<e.length;t++)e[t].shadow.querySelector(".sombrajo").style.display="none"},show:function(){for(var e=f(),t=0;t<e.length;t++)e[t].shadow.querySelector(".sombrajo").style.display="block"},destroy:function(){for(var e=f(),t=0;t<e.length;t++)e[t].shadow.innerHTML="<content></content>";o={},n={},r={}}};var l,a,i,u,s,c,f,d,v,p,h,y,g;return l=function(e){if("undefined"!=typeof e&&null!==e)a(e),o.push(e);else{0===o.length&&(o=i());for(var t=0;t<o.length;t++){var n=o[t];a(n)}}},i=function(){for(var e=[],t=[],o=n.content_selector,r=n.value_selector,l=n.container.querySelectorAll("["+o+"]"),a=0;a<l.length;a++){var i=l[a].getAttribute(o),u=l[a].getAttribute(r);e.indexOf(i)<0&&(t.push({id:i,value:u}),e.push(i))}return t},a=function(e){var t=e.element?[e.element]:v(e.id);e.plots=[],("undefined"==typeof e.value||null===e.value)&&(e.value=t[0].getAttribute(n.value_selector));for(var o=0;o<t.length;o++)e.plots.push({host:t[o]})},u=function(e){var t=function(e){for(var t=e.value,n=r.rank.indexOf(t)+1,o=0;o<e.plots.length;o++){var l=e.plots[o];"undefined"==typeof l.shadow||null===l.shadow?l.shadow=d(l.host,e.value,n):p(l,e.value,n),g(l.shadow,t,r.max)}};if("undefined"!=typeof e&&null!==e&&Object.keys(e).length>0)t(e);else for(var n=0;n<o.length;n++)t(o[n])},s=function(e){e="object"==typeof e?e.id||e.element:e;for(var t=0;t<o.length;t++){var n=o[t];if(n.id==e||n.element===e)return n}return null},c=function(e){for(var t=0;t<e.plots.length;t++)e.plots[t].shadow.innerHTML="<content></content>";for(var n=0;n<o.length;n++){var r=o[n];r.id==e.id&&r.element===e.element&&o.splice(n,1)}},f=function(){for(var e=[],t=0;t<o.length;t++)e=e.concat(o[t].plots);return e},d=function(e,t,n){var o=e.shadowRoot||e.createShadowRoot(),r=window.getComputedStyle(e).getPropertyValue("position");return(""===r||"static"===r)&&(e.style.position="relative"),o.innerHTML=h(o),o.innerHTML+='<figure class="sombrajo" data-rank="'+n+'" data-score="'+t+'"></figure><content></content>',o},v=function(e){return n.container.querySelectorAll("["+n.content_selector+'="'+e+'"]')},p=function(e,t,n){var o=e.shadow.querySelector(".sombrajo");o.setAttribute("data-score",t),o.setAttribute("data-rank",n)},h=function(){var e=n.opacity,t=n.glow?.2*n.glow:0,o="<style>figure.sombrajo { display: block; width: 100%; height: 100%; opacity: "+e+"; position: absolute; z-index: 20; border-radius: "+t+"%; border-color: none; margin: 0; left: 0; top: 0;pointer-events: none; }</style>";return o},y=function(){var t=o.map(function(e){return e.value}),n=t.sort().reverse();return{max:e.max(t),min:e.min(t),rank:n}},g=function(t,o,r){var l=["linear","log"].indexOf(n.scale)>-1?n.scale:"linear",a=e.scale[l].call().range(["blue","turquoise","green","yellow","red"]).domain([0,.25,.5,.75,1]).interpolate(e.interpolateLab),i=(o||1)/r,u=a(i),s=n.glow||0,c=t.querySelector(".sombrajo");c.style.backgroundColor=u,c.style.boxShadow="0px 0px "+s+"px "+s+"px "+u},t});